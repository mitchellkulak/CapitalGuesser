<!DOCTYPE html>
<html>

<head>
    <title>Capital Guesser | Profile</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body onload="CreateTable(), readAndDisplayUserData()">

    <div id="navBar">
        <h1 id="title">World Capital Guesser</h1>
        <ul>
            <li><a href="index.html">Game</a></li>
            <li><a href="score.html">High Scores</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li><a href="login.html">Login</a></li>
        </ul>
    </div>

    <div id="userDataDiv"></div>

    <script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>

    <script>
        //TODO:
        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyApQJhDBdHM_OPLpiYG5jr6bYNgeH0Oqmo",
            authDomain: "capitalguesser-98105.firebaseapp.com",
            databaseURL: "https://capitalguesser-98105.firebaseio.com",
            projectId: "capitalguesser-98105",
            storageBucket: "capitalguesser-98105.appspot.com",
            messagingSenderId: "211259741975"
        };
        firebase.initializeApp(config);
        var UserDatabaseRef = firebase.database().ref("Users");
        var allKeys = [];
        var allScores = [];
        // Retrieve new posts as they are added to our database
        UserDatabaseRef.orderByChild("uid").equalTo(getCookie("currentUser")).on("child_added", function (snapshot) {
            var newPost = snapshot.val();
            //console.log(newPost.username);
            //console.log(newPost.high_score);

            allKeys.push(snapshot.key);

            var newRow = document.createElement('TR');
            newRow.id = snapshot.key;

            var newCell1 = document.createElement('TD');
            newCell1.innerHTML = newPost.name;

            var newCell2 = document.createElement('TD');
            newCell2.innerHTML = newPost.email;

            var newCell3 = document.createElement('TD');
            newCell3.innerHTML = newPost.home_town;

            var newCell4 = document.createElement('TD');
            newCell4.innerHTML = newPost.high_score;

            newRow.appendChild(newCell1);
            newRow.appendChild(newCell2);
            newRow.appendChild(newCell3);
            newRow.appendChild(newCell4);

            var thisTableBody = document.getElementById("tbodyID");
            thisTableBody.appendChild(newRow);

            var thisTable = document.getElementById("profileTable");
            thisTable.appendChild(thisTableBody);

        });
        function CreateTable() {
            //Div
            var myTableDiv = document.getElementById("profileTableDiv");

            //table
            var myTable = document.createElement("table");
            myTable.id = 'profileTable';

            //table body
            var tbody = document.createElement("tbody");
            tbody.id = "tbodyID";

            //header row
            var row1 = document.createElement('TR');

            //name
            var h1 = document.createElement('TH');
            h1.innerHTML = 'Name';
            row1.appendChild(h1);

            //email
            var h2 = document.createElement('TH');
            h2.innerHTML = 'Email';
            row1.appendChild(h2);

            //username
            var h3 = document.createElement('TH');
            h3.innerHTML = 'Home Town';
            row1.appendChild(h3);

            var h4 = document.createElement('TH');
            h4.innerHTML = 'High Score';
            row1.appendChild(h4);


            //add header row to table
            myTable.appendChild(row1);

            //add tbody to table
            myTable.appendChild(tbody);

            //add table to div 
            myTableDiv.appendChild(myTable);
        }

        function readAndDisplayUserData() {
            // UserDatabaseRef.orderByChild("uid").equalTo(getCookie("currentUser")) {


            //var userId = firebase.auth().currentUser.uid;
            UserDatabaseRef.orderByChild("uid").equalTo(getCookie("currentUser")).on("child_added", function (snapshot) {
                //UserDatabaseRef.once('').then(function (snapshot) {
                var name = snapshot.val().name;
                var email = snapshot.val().email;
                var high_score = snapshot.val().high_score;
                var home_town = snapshot.val().home_town;
                //var uid = snapshot.val().uid;
                //console.log(name);
                //console.log(email);

                var txtName = document.getElementById("name");
                var txtEmail = document.getElementById("email");
                var txtHighScore = document.getElementById("high_score");
                var txthomeTown = document.getElementById("homeTown");
                //var txtUid = document.getElementById("uid");

                txtName.value = name;
                txtEmail.value = email;
                txtHighScore.value = high_score;
                txthomeTown.value = home_town;
                //txtUid.value = uid;
            });

        }
        //}

        function writeUserData() {
            
            var txtName = document.getElementById("name");
            var txtEmail = document.getElementById("email");
            var txtHomeTown = document.getElementById("homeTown");

            UserDatabaseRef.set({
                name: txtName.innerHTML,
                email: txtEmail.innerHTML,
                home_town: txtHomeTown.innerHTML
            });

            
        }
        //TODO
        function writeNewPost(uid, username, picture, title, body) {
            // A post entry.
            var postData = {
                author: username,
                uid: uid,
                body: body,
                title: title,
                starCount: 0,
                authorPic: picture
            };

            // Get a key for a new Post.
            var newPostKey = firebase.database().ref().child('posts').push().key;

            // Write the new post's data simultaneously in the posts list and the user's post list.
            var updates = {};
            updates['/posts/' + newPostKey] = postData;
            updates['/user-posts/' + uid + '/' + newPostKey] = postData;

            return firebase.database().ref().update(updates);
        }


    </script>

    <div id="profileTableDiv"></div>

    <div id="crudProfileDiv">
        <label>Name:</label>
        <br>
        <input type="text" name="name" id="name">
        <br>
        <label>Email:</label>
        <br>
        <input type="text" name="email" id="email">
        <br>
        <label>High Score:</label>
        <br>
        <input type="text" name="highScore" id="high_score">
        <br>
        <label>Home Town:</label>
        <br>
        <input type="text" name="homeTown" id="homeTown">
        <!--<br>
        <label>Uid:</label>
        <input type="text" name="uid" readonly id="uid">-->
        <div id="buttons">
            <input type="button" name="btnSave" value="Save" onclick="writeUserData()">
            <input type="button" name="btnDelete" value="Delete">
        </div>
    </div>

</body>

</html>
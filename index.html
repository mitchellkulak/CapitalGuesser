<!DOCTYPE html>
<html>

<head>
  <title>Capital Guesser | Home</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>

  <script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>


  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyClJ73vBth_91Emw0gzXDyeSaGdzVAY_j8&callback=initMap"
    async defer></script>

  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyApQJhDBdHM_OPLpiYG5jr6bYNgeH0Oqmo",
      authDomain: "capitalguesser-98105.firebaseapp.com",
      databaseURL: "https://capitalguesser-98105.firebaseio.com",
      projectId: "capitalguesser-98105",
      storageBucket: "capitalguesser-98105.appspot.com",
      messagingSenderId: "211259741975"
    };
    firebase.initializeApp(config);
    var UserDatabaseRef = firebase.database().ref("Users");
    var CapitalDatabaseRef = firebase.database().ref("Capitals");

    var capitals = [];
    CapitalDatabaseRef.on("child_added", function (snapshot, prevChildKey) {
      var newCapital = snapshot.val();
      capitals.push(newCapital);
    });
    /*
    // Example of a random customer generator
    var faker = require('faker'); // Faker.js

    api.customer = {
      id: random.special(4, 8),
      name: faker.name.findName(),
      phone: faker.phone.phoneNumber("(###) ###-####"),
      address: {
        street: faker.address.streetAddress(),
        city: faker.address.city(),
        state: faker.address.state(),
      }
    };
    */

    var markers = [];
    var currentCountryIndex = 0;
    var totalScore = 0;
    var tries = 0;

    function initMap() {
      // Create a new StyledMapType object, passing it an array of styles,
      // and the name to be displayed on the map type control.
      var styledMapType = new google.maps.StyledMapType(
        [
          {
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#212121"
              }
            ]
          },
          {
            "elementType": "labels",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#757575"
              }
            ]
          },
          {
            "elementType": "labels.text.stroke",
            "stylers": [
              {
                "color": "#212121"
              }
            ]
          },
          {
            "featureType": "administrative",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#757575"
              },
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "administrative.country",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#9e9e9e"
              }
            ]
          },
          {
            "featureType": "administrative.land_parcel",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "administrative.locality",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#bdbdbd"
              }
            ]
          },
          {
            "featureType": "administrative.neighborhood",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "poi",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "poi",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#757575"
              }
            ]
          },
          {
            "featureType": "poi.park",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#181818"
              }
            ]
          },
          {
            "featureType": "poi.park",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#616161"
              }
            ]
          },
          {
            "featureType": "poi.park",
            "elementType": "labels.text.stroke",
            "stylers": [
              {
                "color": "#1b1b1b"
              }
            ]
          },
          {
            "featureType": "road",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "color": "#2c2c2c"
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#8a8a8a"
              }
            ]
          },
          {
            "featureType": "road.arterial",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#373737"
              }
            ]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#3c3c3c"
              }
            ]
          },
          {
            "featureType": "road.highway.controlled_access",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#4e4e4e"
              }
            ]
          },
          {
            "featureType": "road.local",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#616161"
              }
            ]
          },
          {
            "featureType": "transit",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "transit",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#757575"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#000000"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#3d3d3d"
              }
            ]
          }
        ],
        { name: 'Styled Map' });

      // Create a map object, and include the MapTypeId to add
      // to the map type control.
      var map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 43.6, lng: -83.1 },
        zoom: 7,
        disableDefaultUI: true,
        mapTypeControlOptions: {
          mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain',
            'styled_map']
        }

      });

      //Associate the styled map with the MapTypeId and set it to display.
      map.mapTypes.set('styled_map', styledMapType);
      map.setMapTypeId('styled_map');

      google.maps.event.addListener(map, 'click', function (event) {
        placeMarker(event.latLng);
      });

      function placeMarker(location) {
        var marker = new google.maps.Marker({
          position: location,
          map: map
        });
        clearMarkers();
        markers.push(marker);
      }

      function clearMarkers() {
        setMapOnAll(null);
      }

      function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

    }

    //upload users
    function UserProcessUpload() {
      var uploadInfo = document.getElementById("UserUpload");
      if ("files" in uploadInfo) {
        var reader = new FileReader();
        reader.onload = function (event) {
          var jsonObj = JSON.parse(event.target.result);

          /* put your code here, whatever you need to do with jsonObj */
          for (var i = 0; i <= jsonObj.length; i++) {
            UserDatabaseRef.push(jsonObj[i]);
          }
        };

        /* file is an array and we are interested only in the first element */
        reader.readAsText(uploadInfo.files[0]);
      }
    }

    //upload capital data
    function CapitalDataProcessUpload() {
      var uploadInfo = document.getElementById("CapitalDataUpload");
      if ("files" in uploadInfo) {
        var reader = new FileReader();
        reader.onload = function (event) {
          var jsonObj = JSON.parse(event.target.result);

          /* put your code here, whatever you need to do with jsonObj */
          for (var i = 0; i <= jsonObj.length; i++) {
            CapitalDatabaseRef.push(jsonObj[i]);
          }
        };

        /* file is an array and we are interested only in the first element */
        reader.readAsText(uploadInfo.files[0]);
      }
    }

    function generateNewTarget(){
      var submitButton = document.getElementById("submitCapital");
      var startButton = document.getElementById("startButton");
      var targetCapitalDiv = document.getElementById("targetCapitalDiv");
      var capitalName = document.getElementById("capitalName");
      var countryName = document.getElementById("countryName");

      var randomNumber = Math.floor(Math.random() * Math.floor(capitals.length));

      submitButton.style.display = "initial";
      targetCapitalDiv.style.display = "initial";
      startButton.style.display = "none";

      capitalName.innerHTML = capitals[randomNumber].CapitalName;
      countryName.innerHTML = capitals[randomNumber].CountryName;

      currentCountryIndex = randomNumber;

      console.log(capitals[randomNumber]);
    }

    function submitAnswer() {
      answerLat = markers[markers.length - 1].position.lat();
      answerLng = markers[markers.length - 1].position.lng();
      actualLat = capitals[currentCountryIndex].CapitalLatitude;
      actualLng = capitals[currentCountryIndex].CapitalLongitude;
      console.log("Answer Lat: " + answerLat);
      console.log("Answer Lng: " + answerLng);
      console.log("Actual Lat: " + actualLat);
      console.log("Actual Lng: " + actualLng);
      
      var diffLat = Math.abs(answerLat - actualLat);
      var diffLng = Math.abs(answerLng - actualLng);

      console.log("Difference in Lat: " + diffLat);
      console.log("Difference in Lng: " + diffLng);

      var score = 3000 - Math.abs(((diffLat * 2) + diffLng) * 15); 
      
      totalScore += Math.floor(score);
      console.log(totalScore);
      tries++;
      
      //console.log(markers[0].position.lng());
      if(tries<5){
          generateNewTarget();
      }
      else{
        window.location.href = "score.html";
      }
    }

  </script>

  <!-- <div id="UserFileUploadDiv">
    <input id="UserUpload" type="file">
    <button onclick="UserProcessUpload()">Upload Users</button>
  </div>

  <div id="CapitalDataFileUploadDiv">
    <input id="CapitalDataUpload" type="file">
    <button onclick="CapitalDataProcessUpload()">Upload Capitals</button>
  </div> -->

  <div id="navBar">
    <h1 id="title">World Capital Guesser</h1>
    <ul>
      <li class="navItem"><a class="navItem" href="index.html">Game</a></li>
      <li class="navItem"><a class="navItem" href="score.html">High Scores</a></li>
      <li class="navItem"><a class="navItem" href="profile.html">Profile</a></li>
    </ul>
  </div>

  <div id="targetCapitalDiv" >Find: <p id="capitalName">Washington DC</p> <br> <br> Capital of: <p id="countryName">United
      States</p>
  </div>

  <button id="submitCapital" onclick="submitAnswer()">Submit!</button>
  <button id="startButton" onclick="generateNewTarget()">Start!</button>

  <div id="map"></div>


</body>

</html>